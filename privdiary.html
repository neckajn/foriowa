<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>home</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="diary-body">

    <main class="paper-sheet">
        <header class="diary-header">
            <h1 id="admin-trigger" style="cursor: default; user-select: none;">for.iowa</h1>
        </header>

        <section class="diary-content">

            <div class="paper-sheet" id="diary-container">
                
                <div id="seal-gallery"></div> 

            </div>
        </div>
            
        </section>

        <footer class="diary-footer">
            <img src="images/heart-svgrepo.png" alt="Heart Icon" class="heart-icon" id="write-trigger" style="cursor: pointer;">
        </footer>

        <div id="entry-modal" class="modal">
            <div class="modal-content">
                <div class="modal-body">
                    <div id="song-wrapper" style="width: 100%; text-align: center;">
                        <button class="add-song-btn" id="add-song-trigger">add a song</button>
                        <div id="spotify-search-area" style="display: none; width: 100%;">
                            <input type="text" id="song-search-input" placeholder="search for a song..." 
                                class="entry-input" autocomplete="off">
                            <div id="spotify-results" style="max-height: 150px; overflow-y: auto; margin-top: 10px;"></div>
                        </div>
                    </div>

                    <div id="spotify-player-container" style="margin: 0; display: none;"></div>

                    <div id="image-preview-container" style="width: 100%; text-align: center;"></div>
                    
                    <p id="date-display"></p>
                    <textarea placeholder="type here..." class="entry-input" id="diary-textarea"></textarea>
                    
                    <input type="file" id="image-input" accept="image/*" style="display: none;">
                </div>

                <div class="modal-footer">
                    <span class="insert-image" id="insert-image-trigger" style="cursor: pointer;">insert image</span>
                    <button id="delete-entry-btn" style="display:none; background:none; border:none; color:#8A1515; text-decoration:underline; cursor:pointer; font-size:0.8rem;">delete</button>
                    <button class="submit-btn" id="modal-action-btn">submit</button>
                </div>
            </div>
        </div>
        
        <div id="confirm-modal">
            <div class="confirm-content">
                <h3>Are you sure?</h3>
                <div class="confirm-btns">
                    <button id="confirm-no">Cancel</button>
                    <button id="confirm-yes">Yes</button>
                </div>
            </div>
        </div>

        <script type="module">
    // --- FIREBASE SETUP ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyCqSf9nKwtWX_ysMOOG8zbVu92jDd4ytiY",
        authDomain: "for-iowa.firebaseapp.com",
        projectId: "for-iowa",
        storageBucket: "for-iowa.firebasestorage.app",
        messagingSenderId: "536214425299",
        appId: "1:536214425299:web:f0d04cf5fd1e02c462ce26",
        measurementId: "G-Y8ZKWHBTLC"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    
    // --- SECRET LOGIN LOGIC ---
    let clickCount = 0;
    document.getElementById('admin-trigger').addEventListener('click', () => {
        clickCount++;
        if (clickCount === 5) {
            login();
            clickCount = 0;
        }
        setTimeout(() => { clickCount = 0; }, 3000); // Reset if clicks are too slow
    });

    async function login() {
        try {
            const result = await signInWithPopup(auth, provider);
            alert("Authenticated as: " + result.user.email);
        } catch (error) {
            console.error("Login failed", error);
            alert("Login failed: " + error.message);
        }
    }
    window.login = login;

    // --- ELEMENT SELECTORS ---
    const heartBtn = document.getElementById('write-trigger');
    const modal = document.getElementById('entry-modal');
    const addSongBtn = document.getElementById('add-song-trigger');
    const searchArea = document.getElementById('spotify-search-area');
    const searchInput = document.getElementById('song-search-input');
    const resultsDiv = document.getElementById('spotify-results');
    const entryInput = document.getElementById('diary-textarea');
    const actionBtn = document.getElementById('modal-action-btn');
    const imageTrigger = document.getElementById('insert-image-trigger');
    const imageInput = document.getElementById('image-input');
    const imagePreview = document.getElementById('image-preview-container');
    const modalBody = document.querySelector('.modal-body');
    const deleteBtn = document.getElementById('delete-entry-btn');
    const confirmModal = document.getElementById('confirm-modal');

    const CLIENT_ID = 'f7a8d9cc7285457ca9476ba4823485c9';
    const CLIENT_SECRET = '3ec034b519ba46ecbf7dfe9f30a1943f';

    let diaryEntries = [];
    let currentEditId = null;

    async function loadEntries() {
        const q = query(collection(db, "entries"), orderBy("timestamp"));
        const snapshot = await getDocs(q);
        document.getElementById('seal-gallery').innerHTML = ''; // Clear before loading
        diaryEntries = [];
        snapshot.forEach(docSnap => {
            const data = { id: docSnap.id, firestoreId: docSnap.id, ...docSnap.data() };
            diaryEntries.push(data);
            createSeal(data);
        });
    }
    loadEntries();

    // --- MODAL & SAVE LOGIC ---
    heartBtn.addEventListener('click', () => {
        currentEditId = null;
        openModal();
        enableEditMode();
        actionBtn.innerText = "submit";
    });

    window.addEventListener('click', (e) => {
        if (e.target == modal) {
            modal.style.display = 'none';
            heartBtn.style.display = 'block';
        }
    });

    function openModal() {
        modal.style.display = 'flex';
        heartBtn.style.display = 'none';
    }

    function closeModal() {
        modal.style.display = 'none';
        heartBtn.style.display = 'block';
        entryInput.value = '';
        document.getElementById('spotify-player-container').innerHTML = '';
        imagePreview.innerHTML = '';
        actionBtn.innerText = "submit";
        deleteBtn.style.display = 'none';
        const dateDisplay = document.getElementById('date-display');
        if (dateDisplay) {
            dateDisplay.innerText = "";
            dateDisplay.style.display = "none";
        }
    }

    async function saveEntry() {
        const textValue = entryInput.value;
        const songHtml = document.getElementById('spotify-player-container').innerHTML;
        const imagesHtml = imagePreview.innerHTML;

        if (!textValue.trim() && imagesHtml === "") {
            alert("Please write something first.");
            return;
        }

        const entryData = {
            text: textValue,
            songHtml: songHtml,
            images: imagesHtml,
            timestamp: Date.now(),
            displayDate: new Date().toLocaleString('en-US', { 
                weekday: 'long', month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' 
            })
        };

        try {
            if (currentEditId !== null) {
                const entry = diaryEntries.find(e => e.id === currentEditId);
                await updateDoc(doc(db, "entries", entry.firestoreId), entryData);
                alert("Changes saved!");
            } else {
                await addDoc(collection(db, "entries"), entryData);
                alert("New entry submitted!");
            }
            location.reload(); // Refresh to show new seals
        } catch (error) {
            console.error("Save failed:", error);
            if (error.code === 'permission-denied') {
                alert("Permission Denied: Click 'for.iowa' 5 times to login first!");
            } else {
                alert("Error: " + error.message);
            }
        }
    }
    window.saveEntry = saveEntry;
    actionBtn.onclick = saveEntry;

    function createSeal(data) {
        const gallery = document.getElementById('seal-gallery');
        const seal = document.createElement('img');
        seal.src = "images/seal.png";
        seal.className = 'submitted-seal';
        seal.dataset.id = data.id;
        seal.onclick = () => viewEntry(data.id);
        gallery.appendChild(seal);
    }

    function viewEntry(id) {
        const entry = diaryEntries.find(e => e.id === id);
        currentEditId = id;
        entryInput.value = entry.text;
        document.getElementById('spotify-player-container').innerHTML = entry.songHtml;
        imagePreview.innerHTML = entry.images;
        entryInput.readOnly = true;
        deleteBtn.style.display = 'block';
        const dateDisplay = document.getElementById('date-display');
        if (dateDisplay && entry.displayDate) {
            dateDisplay.innerText = "Written on " + entry.displayDate;
            dateDisplay.style.display = "block";
        }
        actionBtn.innerText = "edit";
        actionBtn.onclick = enableEditMode;
        openModal();
    }

    function enableEditMode() {
        entryInput.readOnly = false;
        entryInput.focus();
        const removeBtns = document.querySelectorAll('.remove-img-btn, #remove-song-btn');
        removeBtns.forEach(btn => btn.style.display = 'block');
        actionBtn.innerText = "save changes";
        actionBtn.onclick = saveEntry;
    }

    // --- SPOTIFY ---
    async function getAccessToken() {
        const response = await fetch('https://accounts.spotify.com/api/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Authorization': 'Basic ' + btoa(CLIENT_ID + ':' + CLIENT_SECRET)
            },
            body: 'grant_type=client_credentials'
        });
        const data = await response.json();
        return data.access_token;
    }

    async function searchSpotify(queryStr) {
        try {
            const token = await getAccessToken();
            const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(queryStr)}&type=track&limit=10`, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await response.json();
            displayResults(data.tracks.items);
        } catch (error) { console.error("Spotify error:", error); }
    }

    function displayResults(tracks) {
        resultsDiv.innerHTML = '';
        tracks.forEach(track => {
            const trackEl = document.createElement('div');
            trackEl.className = 'result-item';
            trackEl.innerHTML = `<span>${track.name} - ${track.artists[0].name}</span>`;
            trackEl.onclick = () => {
                document.getElementById('spotify-player-container').innerHTML = `
                    <div style="position: relative;">
                        <button id="remove-song-btn" style="position: absolute; top: -10px; right: -10px; z-index: 10; background: #8A1515; color: white; border-radius: 50%; border:none;">✕</button>
                        <iframe src="https://open.spotify.com/embed/track/${track.id}" width="100%" height="80" frameBorder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>
                    </div>`;
                document.getElementById('spotify-player-container').style.display = 'block';
                searchArea.style.display = 'none';
                document.getElementById('remove-song-btn').onclick = () => {
                    document.getElementById('spotify-player-container').innerHTML = '';
                    addSongBtn.style.display = 'block';
                };
            };
            resultsDiv.appendChild(trackEl);
        });
    }

    searchInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        if (e.target.value.length > 2) {
            debounceTimer = setTimeout(() => searchSpotify(e.target.value), 500);
        }
    });
    let debounceTimer;

    addSongBtn.onclick = () => {
        addSongBtn.style.display = 'none';
        searchArea.style.display = 'block';
    };

    // --- IMAGES ---
    imageTrigger.onclick = () => imageInput.click();
    imageInput.addEventListener('change', function () {
        const file = this.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
            const img = new Image();
            img.src = e.target.result;
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 600; 
                const scale = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const compressed = canvas.toDataURL('image/jpeg', 0.5);
                
                const wrapper = document.createElement('div');
                wrapper.style.position = "relative";
                wrapper.style.display = "inline-block";
                wrapper.innerHTML = `
                    <button class="remove-img-btn" style="position: absolute; top: 0; right: 0; background:red; color:white; border:none;">✕</button>
                    <img src="${compressed}" style="max-width: 150px; border-radius: 10px;">`;
                imagePreview.appendChild(wrapper);
                wrapper.querySelector('.remove-img-btn').onclick = () => wrapper.remove();
            };
        };
        reader.readAsDataURL(file);
    });

    // --- DELETE ---
    document.getElementById('confirm-yes').onclick = async () => {
        const entry = diaryEntries.find(e => e.id === currentEditId);
        await deleteDoc(doc(db, "entries", entry.firestoreId));
        location.reload();
    };
    document.getElementById('confirm-no').onclick = () => confirmModal.style.display = 'none';

</script>

    </main>

</body>

</html>



